---
# This playbook defines tasks to deploy the application stack

- name: Install PostgreSQL database
  hosts: all
  remote_user: root
  tasks:
    - name: Install postgresql package
      apt:
        name: postgresql
    - name: Create Airbods DB user
      user:
        name: airbods
    - name: Install psycopg2
      pip:
        name:
          - psycopg2-binary
    - name: Install PostgreSQL auth config
      copy:
        src: pg_hba.conf
        dest: /etc/postgresql/12/main/pg_hba.conf
    - name: Create postgres user
      user:
        name: postgres
        password: "{{ lookup('file', '/run/secrets/postgres') | password_hash('sha512') }}"
    - name: Install PostgreSQL configuration
      copy:
        src: postgresql.conf
        dest: /etc/postgresql/12/main/postgresql.conf
    - name: Ensure PostgreSQL service is running
      service:
        name: postgresql
        state: restarted

- name: Install Redis database
  hosts: all
  remote_user: root
  tasks:
    - name: Install Redis package
      apt:
        name: redis
    - name: Ensure Redis is running
      service:
        name: redis
        state: restarted

# https://airflow.apache.org/docs/apache-airflow/stable/installation.html
- name: Install Apache Airflow
  hosts: all
  remote_user: root
  tasks:
    - name: Create airflow user
      user:
        name: airflow
        password: "{{ lookup('file', '/run/secrets/airflow') | password_hash('sha512') }}"
    - name: Create Airflow group
      group:
        name: airflow
    - name: Install Airflow prerequisites
      apt:
        name:
          - freetds-bin
          - krb5-user
          - ldap-utils
          - libsasl2-2
          - libsasl2-modules
          - libssl1.1
          - locales
          - lsb-release
          - sasl2-bin
          - sqlite3
          - unixodbc
          - python3-pip
    - name: Install virtualenv
      pip:
        name: virtualenv
    - name: Install Airflow packages
      pip:
        name:
          - apache-airflow[celery]==2.1.*
          - apache-airflow-providers-postgres==1.0.*
          - apache-airflow-providers-google==3.0.*
        virtualenv: /opt/airflow
    - name: Install systemd services
      template:
        src: /etc/ansible/airflow.service.j2
        dest: "/etc/systemd/system/airflow-{{ item }}.service"
      loop: "{{ service }}"
    - name: Install Airflow configuration
      copy:
        src: airflow.cfg
        dest: /home/airflow/airflow/airflow.cfg
        owner: airflow
    - name: Secure secrets dir
      file:
        path: /home/airflow/secrets
        state: directory
        mode: '0500'
    - name: Install connection string
      copy:
        src: /run/secrets/sql_alchemy_conn_localhost
        dest: /home/airflow/secrets/sql_alchemy_conn_localhost.txt
        owner: airflow
        mode: '0400'
    - name: Install Airflow connections
      copy:
        src: /run/secrets/connections
        dest: /home/airflow/secrets/connections.json
        owner: airflow
        mode: '0400'
    - name: Install Airflow variables
      copy:
        src: /run/secrets/variables
        dest: /home/airflow/secrets/variables.json
        owner: airflow
        mode: '0400'
    - name: Start systemd services
      systemd:
        name: "airflow-{{ item }}"
        state: restarted
        daemon_reload: true
      loop: "{{ service }}"
    - name: Create airflow database user
      become: true
      become_user: postgres
      community.postgresql.postgresql_user:
        user: airflow
        password: "{{ lookup('file', '/run/secrets/airflow') }}"
    - name: Create airflow database
      become: true
      become_user: postgres
      community.postgresql.postgresql_db:
        name: airflow
    - name: Initialise Airflow database
      remote_user: airflow
      # "initdb is also idempotent, so this can be run as often as you
      # choose to, without needing to worry about the database changing."
      # https://stackoverflow.com/a/59560731
      shell: /opt/airflow/bin/airflow db init
